<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Dot.io — Mobile</title>
<style>
:root{--bg:#fff;--ui:#111827;--accent:#0ea5a4;--food-border:rgba(0,0,0,0.06);}
html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,sans-serif;color:var(--ui);user-select:none;-webkit-user-select:none;-ms-user-select:none;-webkit-touch-callout:none;}
canvas{display:block;}
.scoreTop{position:fixed;left:50%;top:12px;transform:translateX(-50%);z-index:20;background:rgba(255,255,255,0.85);padding:8px 14px;border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,0.06);font-weight:700}
.scoreNum{font-size:20px}
.scoreboard{position:fixed;right:12px;top:12px;z-index:20;background:rgba(255,255,255,0.95);padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,0.06);width:160px}
.minimap{position:fixed;left:12px;top:12px;z-index:20;background:rgba(0,0,0,0.85);color:#fff;padding:8px;border-radius:8px;width:150px}
.joyWrap{position:fixed;left:12px;bottom:12px;z-index:22;width:140px;height:140px;border-radius:999px;touch-action:none}
.joyBase{width:100%;height:100%;border-radius:999px;background:rgba(15,23,42,0.06);display:flex;align-items:center;justify-content:center}
.joyKnob{width:56px;height:56px;border-radius:999px;background:linear-gradient(180deg,#fff,#f3f4f6);box-shadow:0 6px 12px rgba(2,6,23,0.08);transform:translate(0,0)}
.shrinkBtn{position:fixed;right:12px;bottom:12px;z-index:22;width:92px;height:92px;border-radius:18px;background:linear-gradient(180deg,#fff,#f8fafc);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(2,6,23,0.08);font-weight:700}
.shrinkBtn.active{background:linear-gradient(180deg,#fde68a,#f59e0b)}
.small{font-size:12px;opacity:.9}
</style>
</head>
<body>

<div class="scoreTop"><span class="small">Score</span><div class="scoreNum" id="scoreNum">0</div></div>
<div class="scoreboard">
  <div style="font-weight:800">Scoreboard</div>
  <div style="margin-top:8px">Player: <strong id="playerName">You</strong></div>
  <div>Score: <strong id="playerScore">0</strong></div>
</div>
<div class="minimap">Map<div id="miniCanvasHolder" style="margin-top:6px"></div></div>
<div class="joyWrap" id="joyWrap"><div class="joyBase" id="joyBase"><div class="joyKnob" id="joyKnob"></div></div></div>
<div class="shrinkBtn" id="shrinkBtn">Power</div>
<canvas id="c"></canvas>
<audio id="bgSound" src="bg.mp3" loop preload="auto"></audio>
<audio id="dotSound" src="dot.mp3" preload="auto"></audio>
<audio id="powerSound" src="power.mp3" loop preload="auto"></audio>

<script>
// ---------- Settings ----------
const WORLD = {w:5000,h:5000};
const FOOD_COUNT=1000, FOOD_RADIUS=6, PLAYER_START_MASS=20, GRID_SIZE=120;
const canvas=document.getElementById('c'), ctx=canvas.getContext('2d',{alpha:false});
let DPR=Math.min(window.devicePixelRatio||1,2);
function resize(){DPR=Math.min(window.devicePixelRatio||1,2);canvas.width=Math.floor(window.innerWidth*DPR);canvas.height=Math.floor(window.innerHeight*DPR);canvas.style.width=window.innerWidth+'px';canvas.style.height=window.innerHeight+'px';ctx.setTransform(DPR,0,0,DPR,0,0);}
window.addEventListener('resize',resize,{passive:true});resize();

// ---------- State ----------
let foods=[], player={x:WORLD.w/2,y:WORLD.h/2,mass:PLAYER_START_MASS,vx:0,vy:0,id:1,power:false,shrinkScale:0.65}, score=0, camera={x:player.x,y:player.y}, target=null;
const nameEl=document.getElementById('playerName');
(function initName(){let saved=localStorage.getItem('dotio_name');if(!saved){saved=(prompt('İsminizi yazın / Enter your name:','You')||'You').toString().slice(0,24);localStorage.setItem('dotio_name',saved);}nameEl.innerText=saved;})();

// ---------- Helpers ----------
function rand(min,max){return Math.random()*(max-min)+min;}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function worldToScreen(wx,wy){const cx=camera.x-window.innerWidth/2,cy=camera.y-window.innerHeight/2;return {x:wx-cx,y:wy-cy};}
function screenToWorld(sx,sy){const cx=camera.x-window.innerWidth/2,cy=camera.y-window.innerHeight/2;return {x:sx+cx,y:sy+cy};}

// ---------- Food ----------
function makeFood(){return {x:rand(20,WORLD.w-20),y:rand(20,WORLD.h-20),r:FOOD_RADIUS*(0.7+Math.random()*0.7),color:`hsl(${Math.floor(rand(0,360))},80%,60%)`};}
function spawnFood(n){for(let i=0;i<n;i++)foods.push(makeFood());}
spawnFood(FOOD_COUNT);

// ---------- Audio ----------
const bgSound=document.getElementById('bgSound'), dotSound=document.getElementById('dotSound'), powerSound=document.getElementById('powerSound');
let audioUnlocked=false;
function unlockAudio(){if(audioUnlocked)return;audioUnlocked=true;bgSound.volume=0.5;bgSound.play().catch(()=>{});}
['pointerdown','touchstart','mousedown','keydown'].forEach(ev=>window.addEventListener(ev,unlockAudio,{once:true,passive:true}));

// ---------- Joystick ----------
const joyWrap=document.getElementById('joyWrap'), joyBase=document.getElementById('joyBase'), joyKnob=document.getElementById('joyKnob');
let joy={active:false,id:null,ox:0,oy:0,dx:0,dy:0};
function setKnob(dx,dy){const max=40,d=Math.hypot(dx,dy)||1;const nx=(d>max?dx*(max/d):dx),ny=(d>max?dy*(max/d):dy);joyKnob.style.transform=`translate(${nx}px,${ny}px)`;joy.dx=nx/max;joy.dy=ny/max;}
joyWrap.addEventListener('pointerdown',e=>{e.preventDefault();joy.active=true;joy.id=e.pointerId;const rect=joyWrap.getBoundingClientRect();joy.ox=rect.left+rect.width/2;joy.oy=rect.top+rect.height/2;setKnob(e.clientX-joy.ox,e.clientY-joy.oy);joyWrap.setPointerCapture(e.pointerId);});
joyWrap.addEventListener('pointermove',e=>{if(!joy.active||e.pointerId!==joy.id)return;e.preventDefault();setKnob(e.clientX-joy.ox,e.clientY-joy.oy);});
function endJoy(e){if(!joy.active||e.pointerId!==joy.id)return;joy.active=false;joy.id=null;joy.dx=0;joy.dy=0;joyKnob.style.transform='translate(0,0)';}
joyWrap.addEventListener('pointerup',endJoy);joyWrap.addEventListener('pointercancel',endJoy);

// Tap-to-move (only sets target on click/tap)
window.addEventListener('pointerdown',e=>{const jr=joyWrap.getBoundingClientRect();const pr=shrinkBtn.getBoundingClientRect();if(e.clientX>=jr.left&&e.clientX<=jr.right&&e.clientY>=jr.top&&e.clientY<=jr.bottom)return;if(e.clientX>=pr.left&&e.clientX<=pr.right&&e.clientY>=pr.top&&e.clientY<=pr.bottom)return;target=screenToWorld(e.clientX,e.clientY);},{passive:true});

// ---------- Power ----------
const shrinkBtn=document.getElementById('shrinkBtn');let powerDrainInterval=null;
function startPower(){if(player.power)return;player.power=true;shrinkBtn.classList.add('active');powerDrainInterval=setInterval(()=>{score=Math.max(0,score-1);updateUI();},1000);powerSound.currentTime=0;powerSound.play().catch(()=>{});}
function stopPower(){if(!player.power)return;player.power=false;shrinkBtn.classList.remove('active');if(powerDrainInterval){clearInterval(powerDrainInterval);powerDrainInterval=null;}powerSound.pause();}
shrinkBtn.addEventListener('pointerdown',e=>{e.preventDefault();startPower();});shrinkBtn.addEventListener('pointerup',e=>{e.preventDefault();stopPower();});shrinkBtn.addEventListener('pointercancel',e=>{stopPower();});
document.addEventListener('visibilitychange',()=>{if(document.hidden)stopPower();});

// ---------- Movement ----------
function playerSpeed(){let base=5.2,massFactor=Math.pow(player.mass,0.18),sp=base/massFactor;if(player.power)sp*=1.9;return sp;}
function updateCamera(){camera.x+=(player.x-camera.x)*0.14;camera.y+=(player.y-camera.y)*0.14;}
function enforceWalls(){player.x=clamp(player.x,1,WORLD.w-1);player.y=clamp(player.y,1,WORLD.h-1);}
function eatFood(){for(let i=foods.length-1;i>=0;i--){const f=foods[i];const dx=f.x-player.x,dy=f.y-player.y;const r=Math.sqrt(player.mass)*6*(player.power?player.shrinkScale:1)+f.r;if(dx*dx+dy*dy<=r*r){player.mass+=0.6;score+=1;updateUI();foods.splice(i,1);foods.push(makeFood());try{dotSound.currentTime=0;dotSound.play();}catch(e){}}}}

// ---------- Draw ----------
function drawGrid(){const g=GRID_SIZE;let startX=camera.x-window.innerWidth/2;let startY=camera.y-window.innerHeight/2;let x0=Math.floor(startX/g)*g;let y0=Math.floor(startY/g)*g;ctx.save();ctx.lineWidth=1;ctx.strokeStyle='rgba(0,0,0,0.04)';for(let x=x0;x<startX+window.innerWidth;x+=g){ctx.beginPath();let sx=x-startX;ctx.moveTo(sx,0);ctx.lineTo(sx,window.innerHeight);ctx.stroke();}for(let y=y0;y<startY+window.innerHeight;y+=g){ctx.beginPath();let sy=y-startY;ctx.moveTo(0,sy);ctx.lineTo(window.innerWidth,sy);ctx.stroke();}ctx.restore();}
function draw(){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle='#fff';ctx.fillRect(0,0,window.innerWidth,window.innerHeight);drawGrid();const topLeft=worldToScreen(0,0),bottomRight=worldToScreen(WORLD.w,WORLD.h);ctx.save();ctx.strokeStyle='#000';ctx.lineWidth=12;ctx.strokeRect(topLeft.x,topLeft.y,bottomRight.x-topLeft.x,bottomRight.y-topLeft.y);ctx.restore();for(const f of foods){const s=worldToScreen(f.x,f.y);if(s.x<-50||s.x>window.innerWidth+50||s.y<-50||s.y>window.innerHeight+50)continue;ctx.beginPath();ctx.fillStyle=f.color;ctx.strokeStyle='rgba(0,0,0,0.06)';ctx.lineWidth=1;ctx.arc(s.x,s.y,f.r,0,Math.PI*2);ctx.fill();ctx.stroke();}let pr=Math.sqrt(player.mass)*6;if(player.power)pr*=player.shrinkScale;const ps=worldToScreen(player.x,player.y);ctx.beginPath();let grad=ctx.createRadialGradient(ps.x,ps.y,pr*0.2,ps.x,ps.y,pr*1.6);grad.addColorStop(0,'rgba(14,165,164,0.12)');grad.addColorStop(1,'rgba(14,165,164,0)');ctx.fillStyle=grad;ctx.arc(ps.x,ps.y,pr*1.6,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.fillStyle='#06b6d4';ctx.arc(ps.x,ps.y,pr,0,Math.PI*2);ctx.fill();ctx.font='12px system-ui';ctx.fillStyle='#0f172a';ctx.textAlign='center';ctx.fillText(nameEl.innerText,ps.x,ps.y-pr-8);renderMiniMap();}
const miniHolder=document.getElementById('miniCanvasHolder');const miniW=120,miniH=80;const miniCanvas=document.createElement('canvas');miniCanvas.width=miniW;miniCanvas.height=miniH;miniCanvas.style.width=miniW+'px';miniCanvas.style.height=miniH+'px';miniHolder.appendChild(miniCanvas);const mctx=miniCanvas.getContext('2d');
function renderMiniMap(){mctx.clearRect(0,0,miniW,miniH);mctx.fillStyle='#0b0b0b';mctx.fillRect(0,0,miniW,miniH);for(const f of foods){const mx=(f.x/WORLD.w)*miniW,my=(f.y/WORLD.h)*miniH;mctx.fillStyle=f.color;mctx.fillRect(mx-1,my-1,2,2);}const px=(player.x/WORLD.w)*miniW,py=(player.y/WORLD.h)*miniH;mctx.fillStyle='#06b6d4';mctx.beginPath();mctx.arc(px,py,3,0,Math.PI*2);mctx.fill();mctx.strokeStyle='#000';mctx.lineWidth=2;mctx.strokeRect(0,0,miniW,miniH);}
function updateUI(){document.getElementById('playerScore').innerText=score;document.getElementById('scoreNum').innerText=score;}
updateUI();

// ---------- Loop ----------
let prev=performance.now();
function loop(now){
  const dt=Math.min((now-prev)/16.6667,4); prev=now;
  const sp=playerSpeed()*dt;
  if(joy.active){
    const mag=Math.hypot(joy.dx,joy.dy);
    if(mag>0.05){player.vx=(joy.dx/(mag||1))*sp;player.vy=(joy.dy/(mag||1))*sp;} else {player.vx*=0.86;player.vy*=0.86;}
  } else if(target){ // only move if there is a tap target
    let dx=target.x-player.x,dy=target.y-player.y;const d=Math.hypot(dx,dy);
    if(d>4){player.vx=(dx/d)*sp;player.vy=(dy/d)*sp;} else {player.vx*=0.86;player.vy*=0.86;}
  } else {
    // joystick yok ve target yok, dur
    player.vx=0;player.vy=0;
  }

  player.x+=player.vx; player.y+=player.vy;
  enforceWalls(); eatFood(); updateCamera(); draw(); requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
setInterval(()=>{if(foods.length<FOOD_COUNT)spawnFood(FOOD_COUNT-foods.length);},2000);
console.log('Dot.io mobile — joystick fix: bırakınca duruyor.');
</script>
</body>
</html>
