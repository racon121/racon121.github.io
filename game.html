<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Mini Brawl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      overflow: hidden;
      font-family: 'Lilita One', cursive, sans-serif;
      background: #e0dccc;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    #canvas {
      display: block;
      background: #f2eecb;
      border: 3px solid #aaa;
      border-radius: 12px;
      margin: 0 auto;
      touch-action: none;
      image-rendering: pixelated;
    }
    #joystick {
      position: fixed;
      left: 20px;
      bottom: 20px;
      width: 100px;
      height: 100px;
      background: rgba(200, 200, 200, 0.25);
      border-radius: 50%;
      touch-action: none;
      user-select: none;
      z-index: 10;
    }
    #stick {
      position: absolute;
      width: 40px;
      height: 40px;
      left: 30px;
      top: 30px;
      background: rgba(100, 100, 100, 0.7);
      border-radius: 50%;
      user-select: none;
    }
    #respawnText {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 36px;
      font-weight: bold;
      color: #b22222;
      text-shadow: 2px 2px 4px #000;
      pointer-events: none;
      user-select: none;
      display: none;
      z-index: 15;
    }
  </style>
</head>
<body>

<canvas id="canvas"></canvas>
<div id="joystick"><div id="stick"></div></div>
<div id="respawnText"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

  // Firebase yapılandırması
  const firebaseConfig = {
    apiKey: "AIzaSyCfhlU2Y45L8B-cFGjR_x1uy0O8amoLxzc",
    authDomain: "game-fea7a.firebaseapp.com",
    databaseURL: "https://game-fea7a-default-rtdb.firebaseio.com",
    projectId: "game-fea7a",
    storageBucket: "game-fea7a.appspot.com",
    messagingSenderId: "561246725065",
    appId: "1:561246725065:web:116991551ba3696514fe18"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const urlParams = new URLSearchParams(window.location.search);
  const room = urlParams.get("room");
  const user = urlParams.get("user");

  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  // Harita boyutları (sanal koordinatlar)
  const gameWidth = 1600;
  const gameHeight = 1000;

  // Karakter boyutu büyütüldü
  const playerSize = 48;

  // Canvas fullscreen ve yüksek çözünürlük ayarı
  function resizeCanvas() {
    const dpr = window.devicePixelRatio || 1;
    canvas.style.width = window.innerWidth + "px";
    canvas.style.height = window.innerHeight + "px";
    canvas.width = window.innerWidth * dpr;
    canvas.height = window.innerHeight * dpr;
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    // Ölçek 1:1 yapıyoruz, çünkü kamera offset kullanacağız
    ctx.scale(dpr, dpr);
  }
  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  // Karakter resmi
  const karakter = new Image();
  karakter.src = "karakter.png"; // Aynı klasörde olmalı

  // Oyuncu başlangıç pozisyonu
  let x = Math.random() * (gameWidth - playerSize);
  let y = Math.random() * (gameHeight - playerSize);
  let speed = 1.2; // biraz yavaşlatıldı
  let health = 5;
  let maxHealth = 5;
  let isAlive = true;

  // Mermi özellikleri
  let bullets = [];
  let maxAmmo = 3;
  let currentAmmo = 3;
  let bulletSpeed = 7;
  let reloadTime = 800;
  let lastShotTime = 0;

  // Yeniden doğma
  let respawnTime = 5000;
  let respawnCountdown = 0;
  let respawnInterval = null;

  // Duvarlar (Brawl Stars tarzı kutular)
  const blocks = [
    { x: 400, y: 150, w: 150, h: 150 },
    { x: 1100, y: 150, w: 150, h: 150 },
    { x: 700, y: 500, w: 200, h: 200 },
    { x: 300, y: 800, w: 170, h: 170 },
    { x: 1150, y: 750, w: 180, h: 180 },
  ];

  // Firebase referansları
  const playerRef = ref(db, `rooms/${room}/players/${user}`);
  const allPlayersRef = ref(db, `rooms/${room}/players`);

  set(playerRef, { x, y, health, isAlive });
  window.addEventListener("beforeunload", () => remove(playerRef));

  let players = {};
  onValue(allPlayersRef, snapshot => {
    players = snapshot.val() || {};
  });

  // Joystick kontrolü
  const joystick = document.getElementById("joystick");
  const stick = document.getElementById("stick");
  let joyX = 0, joyY = 0;

  joystick.addEventListener("touchstart", e => e.preventDefault());
  joystick.addEventListener("touchmove", e => {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = joystick.getBoundingClientRect();
    const dx = touch.clientX - (rect.left + 50);
    const dy = touch.clientY - (rect.top + 50);
    const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
    const angle = Math.atan2(dy, dx);
    joyX = Math.cos(angle) * dist/40;
    joyY = Math.sin(angle) * dist/40;
    stick.style.left = `${30 + joyX*20}px`;
    stick.style.top = `${30 + joyY*20}px`;
  });

  joystick.addEventListener("touchend", () => {
    joyX = 0;
    joyY = 0;
    stick.style.left = "30px";
    stick.style.top = "30px";
  });

  // Mermi atma
  canvas.addEventListener("touchstart", e => {
    e.preventDefault();
    if (!isAlive) return;
    const now = Date.now();
    if (currentAmmo > 0 && now - lastShotTime > 150) {
      bullets.push({
        x: x + playerSize/2,
        y: y + playerSize/2,
        dx: joyX === 0 && joyY === 0 ? 0 : joyX * bulletSpeed,
        dy: joyX === 0 && joyY === 0 ? -bulletSpeed : joyY * bulletSpeed,
      });
      currentAmmo--;
      lastShotTime = now;
    }
  });

  // Mermi dolumu
  setInterval(() => {
    if (currentAmmo < maxAmmo) currentAmmo++;
  }, reloadTime);

  // Çarpışma fonksiyonları
  function rectsCollide(ax, ay, aw, ah, bx, by, bw, bh) {
    return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
  }

  function checkPlayerCollision(nx, ny) {
    if (nx < 0 || ny < 0 || nx > gameWidth - playerSize || ny > gameHeight - playerSize) return true;
    for (let block of blocks) {
      if (rectsCollide(nx, ny, playerSize, playerSize, block.x, block.y, block.w, block.h)) return true;
    }
    return false;
  }

  function checkBulletCollision(bullet) {
    if (bullet.x < 0 || bullet.y < 0 || bullet.x > gameWidth || bullet.y > gameHeight) return true;
    for (let block of blocks) {
      if (rectsCollide(bullet.x - 5, bullet.y - 5, 10, 10, block.x, block.y, block.w, block.h)) return true;
    }
    return false;
  }

  function checkBulletHitPlayer(bullet, target) {
    return rectsCollide(
      bullet.x - 5, bullet.y - 5, 10, 10,
      target.x, target.y, playerSize, playerSize
    );
  }

  // Yeniden doğma
  const respawnText = document.getElementById("respawnText");

  function startRespawn() {
    isAlive = false;
    respawnCountdown = respawnTime / 1000;
    respawnText.style.display = "block";
    updateRespawnText();

    respawnInterval = setInterval(() => {
      respawnCountdown--;
      if (respawnCountdown <= 0) {
        clearInterval(respawnInterval);
        respawnText.style.display = "none";
        health = maxHealth;
        isAlive = true;
        do {
          x = Math.random() * (gameWidth - playerSize);
          y = Math.random() * (gameHeight - playerSize);
        } while (checkPlayerCollision(x, y));
      } else {
        updateRespawnText();
      }
    }, 1000);
  }

  function updateRespawnText() {
    respawnText.textContent = `Yeniden Doğma: ${respawnCountdown}`;
  }

  // Oyun döngüsü
  function gameLoop() {
    requestAnimationFrame(gameLoop);

    if (isAlive) {
      let nx = x + joyX * speed;
      let ny = y + joyY * speed;

      if (!checkPlayerCollision(nx, y)) x = nx;
      if (!checkPlayerCollision(x, ny)) y = ny;
    }

    set(playerRef, { x, y, health, isAlive });

    bullets = bullets.filter(b => {
      b.x += b.dx;
      b.y += b.dy;

      if (checkBulletCollision(b)) return false;

      for (let name in players) {
        if (name !== user && players[name].isAlive) {
          if (checkBulletHitPlayer(b, players[name])) {
            const targetRef = ref(db, `rooms/${room}/players/${name}`);
            let newHealth = Math.max(0, players[name].health - 1);
            set(targetRef, {...players[name], health: newHealth});
            if (newHealth <= 0) {
              set(targetRef, {...players[name], health: 0, isAlive: false});
            }
            return false;
          }
        }
      }
      if (b.x < 0 || b.x > gameWidth || b.y < 0 || b.y > gameHeight) return false;
      return true;
    });

    if (health <= 0 && isAlive) {
      startRespawn();
    }

    // Kamera ayarları: oyuncuyu ekranın ortasında tut
    const screenWidth = canvas.width / (window.devicePixelRatio || 1);
    const screenHeight = canvas.height / (window.devicePixelRatio || 1);

    let camX = x + playerSize/2 - screenWidth / 2;
    let camY = y + playerSize/2 - screenHeight / 2;

    // Kamera sınırları harita dışına çıkmasın
    camX = Math.max(0, Math.min(camX, gameWidth - screenWidth));
    camY = Math.max(0, Math.min(camY, gameHeight - screenHeight));

    // Canvas temizle ve kamerayı uygula
    ctx.clearRect(0, 0, screenWidth, screenHeight);
    ctx.save();
    ctx.translate(-camX, -camY);

    // Duvarları çiz
    blocks.forEach(block => {
      let gradient = ctx.createLinearGradient(block.x, block.y, block.x + block.w, block.y + block.h);
      gradient.addColorStop(0, "#b36b00");
      gradient.addColorStop(1, "#d9a800");
      ctx.fillStyle = gradient;
      const radius = 25;
      roundRect(ctx, block.x, block.y, block.w, block.h, radius, true, true);
      ctx.strokeStyle = "#7a4e00";
      ctx.lineWidth = 3;
      roundRect(ctx, block.x + 2, block.y + 2, block.w - 4, block.h - 4, radius - 8, false, true);
    });

    // Diğer oyuncular
    for (let name in players) {
      const p = players[name];
      if (!p.isAlive) continue;
      ctx.drawImage(karakter, p.x, p.y, playerSize, playerSize);
      ctx.fillStyle = "#000";
      ctx.font = "bold 16px Lilita One, cursive";
      ctx.textAlign = "center";
      ctx.fillText(name, p.x + playerSize/2, p.y - 12);
      // Can barı
      ctx.fillStyle = "red";
      ctx.fillRect(p.x, p.y - 20, playerSize, 5);
      ctx.fillStyle = "limegreen";
      ctx.fillRect(p.x, p.y - 20, playerSize * (p.health / maxHealth), 5);
    }

    // Kendi karakteri çiz
    if (isAlive) {
      ctx.drawImage(karakter, x, y, playerSize, playerSize);
      ctx.fillStyle = "red";
      ctx.fillRect(x, y - 20, playerSize, 5);
      ctx.fillStyle = "limegreen";
      ctx.fillRect(x, y - 20, playerSize * (health / maxHealth), 5);
      ctx.fillStyle = "#000";
      ctx.font = "bold 16px Lilita One, cursive";
      ctx.textAlign = "center";
      ctx.fillText(user, x + playerSize/2, y - 12);
    }

    // Mermileri çiz
    ctx.fillStyle = "yellow";
    bullets.forEach(b => {
      ctx.beginPath();
      ctx.arc(b.x, b.y, 7, 0, Math.PI * 2);
      ctx.fill();
    });

    // Mermi sayısı UI (sağ üst köşe ekran koordinatı)
    ctx.restore(); // Kamerayı geri al
    ctx.fillStyle = "#000";
    for (let i = 0; i < maxAmmo; i++) {
      ctx.fillStyle = i < currentAmmo ? "#FFD700" : "#999";
      ctx.beginPath();
      ctx.arc(canvas.width / (window.devicePixelRatio || 1) - 30 - i * 20, 30, 8, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  // Yuvarlak köşe dikdörtgen çizme fonksiyonu
  function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
    if (typeof stroke === 'undefined') stroke = true;
    if (typeof radius === 'undefined') radius = 5;
    if (typeof radius === 'number') {
      radius = { tl: radius, tr: radius, br: radius, bl: radius };
    } else {
      let defaultRadius = { tl: 0, tr: 0, br: 0, bl: 0 };
      for (let side in defaultRadius) radius[side] = radius[side] || defaultRadius[side];
    }
    ctx.beginPath();
    ctx.moveTo(x + radius.tl, y);
    ctx.lineTo(x + width - radius.tr, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
    ctx.lineTo(x + width, y + height - radius.br);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
    ctx.lineTo(x + radius.bl, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
    ctx.lineTo(x, y + radius.tl);
    ctx.quadraticCurveTo(x, y, x + radius.tl, y);
    ctx.closePath();
    if (fill) ctx.fill();
    if (stroke) ctx.stroke();
  }

  gameLoop();
</script>

</body>
</html>
