<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Dot.io — Mobile</title>
<style>
:root{--bg:#fff;--ui:#111827;--accent:#0ea5a4;--food-border:rgba(0,0,0,0.06);}
html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,sans-serif;color:var(--ui);user-select:none;-webkit-user-select:none;-ms-user-select:none;-webkit-touch-callout:none;}
canvas{display:block;}
.scoreTop{position:fixed;left:50%;top:12px;transform:translateX(-50%);z-index:20;background:rgba(255,255,255,0.85);padding:8px 14px;border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,0.06);font-weight:700}
.scoreNum{font-size:20px}
.scoreboard{position:fixed;right:12px;top:12px;z-index:20;background:rgba(255,255,255,0.95);padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,0.06);width:160px}
.minimap{position:fixed;left:12px;top:12px;z-index:20;background:rgba(0,0,0,0.85);color:#fff;padding:8px;border-radius:8px;width:150px}
.joyWrap{position:fixed;left:12px;bottom:12px;z-index:22;width:140px;height:140px;border-radius:999px;touch-action:none}
.joyBase{width:100%;height:100%;border-radius:999px;background:rgba(15,23,42,0.06);display:flex;align-items:center;justify-content:center}
.joyKnob{width:56px;height:56px;border-radius:999px;background:linear-gradient(180deg,#fff,#f3f4f6);box-shadow:0 6px 12px rgba(2,6,23,0.08);transform:translate(0,0)}
.shrinkBtn{position:fixed;right:12px;bottom:12px;z-index:22;width:92px;height:92px;border-radius:18px;background:linear-gradient(180deg,#fff,#f8fafc);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(2,6,23,0.08);font-weight:700;touch-action:none}
.shrinkBtn.active{background:linear-gradient(180deg,#fde68a,#f59e0b)}
.small{font-size:12px;opacity:.9}
</style>
</head>
<body>
<div class="scoreTop"><span class="small">Score</span><div class="scoreNum" id="scoreNum">0</div></div>
<div class="scoreboard">
  <div style="font-weight:800">Scoreboard</div>
  <div style="margin-top:8px">Player: <strong id="playerName">You</strong></div>
  <div>Score: <strong id="playerScore">0</strong></div>
</div>
<div class="minimap">Map<div id="miniCanvasHolder" style="margin-top:6px"></div></div>
<div class="joyWrap" id="joyWrap"><div class="joyBase" id="joyBase"><div class="joyKnob" id="joyKnob"></div></div></div>
<div class="shrinkBtn" id="shrinkBtn">Power</div>
<canvas id="c"></canvas>
<audio id="bgSound" src="bg.mp3" loop preload="auto"></audio>
<audio id="dotSound" src="dot.mp3" preload="auto"></audio>
<audio id="powerSound" src="power.mp3" loop preload="auto"></audio>

<script>
// ---------- Settings ----------
const WORLD = {w:5000,h:5000};
const FOOD_COUNT=1000, FOOD_RADIUS=6, PLAYER_START_MASS=20, GRID_SIZE=120;
const canvas=document.getElementById('c'), ctx=canvas.getContext('2d',{alpha:false});
let DPR=Math.min(window.devicePixelRatio||1,2);
function resize(){DPR=Math.min(window.devicePixelRatio||1,2);canvas.width=Math.floor(window.innerWidth*DPR);canvas.height=Math.floor(window.innerHeight*DPR);canvas.style.width=window.innerWidth+'px';canvas.style.height=window.innerHeight+'px';ctx.setTransform(DPR,0,0,DPR,0,0);}
window.addEventListener('resize',resize,{passive:true});resize();

// ---------- State ----------
let foods=[], players=[], player=null, score=0, camera={x:0,y:0}, target=null;
const nameEl=document.getElementById('playerName');
(function initName(){let saved=localStorage.getItem('dotio_name');if(!saved){saved=(prompt('İsminizi yazın / Enter your name:','You')||'You').toString().slice(0,24);localStorage.setItem('dotio_name',saved);}nameEl.innerText=saved;})();

// ---------- WebSocket Multiplayer ----------
let socket = new WebSocket('ws://localhost:3000'); // server.js ile bağlanacak
socket.addEventListener('open',()=>{console.log('Connected to server');});
socket.addEventListener('message',msg=>{
  const data=JSON.parse(msg.data);
  if(data.type==='update'){
    players = data.players.map(p=> {
      if(p.id===player.id) return player;
      let np = new Player(p.id,p.name,p.x,p.y,p.color);
      np.mass = p.mass; np.score = p.score;
      return np;
    });
  }
});

// ---------- Helpers ----------
function rand(min,max){return Math.random()*(max-min)+min;}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function worldToScreen(wx,wy){const cx=camera.x-window.innerWidth/2,cy=camera.y-window.innerHeight/2;return {x:wx-cx,y:wy-cy};}
function dist(ax,ay,bx,by){const dx=ax-bx,dy=ay-by;return Math.sqrt(dx*dx+dy*dy);}

// ---------- Entities ----------
class Player {
  constructor(id,name,x,y,color){
    this.id=id;this.name=name;this.x=x;this.y=y;this.mass=PLAYER_START_MASS;this.vx=0;this.vy=0;
    this.color=color;this.dead=false;this.score=0;this.shrinkActive=false;
  }
  radius(){return Math.sqrt(this.mass)*6;}
}
function respawn(p){
  p.x=rand(200,WORLD.w-200);p.y=rand(200,WORLD.h-200);p.mass=PLAYER_START_MASS;p.score=0;p.dead=false;
}
function dropFood(px,py,amount){
  for(let i=0;i<amount;i++){
    foods.push({x:px+rand(-50,50),y:py+rand(-50,50),r:FOOD_RADIUS*(0.7+Math.random()*0.7),color:`hsl(${Math.floor(rand(0,360))},80%,60%)`});
  }
}
function killPlayer(p){
  dropFood(p.x,p.y,Math.floor(p.score/2));
  respawn(p);
  if(p===player){ score = 0; updateUI(); }
}

// ---------- Food ----------
function makeFood(){return {x:rand(20,WORLD.w-20),y:rand(20,WORLD.h-20),r:FOOD_RADIUS*(0.7+Math.random()*0.7),color:`hsl(${Math.floor(rand(0,360))},80%,60%)`};}
function spawnFood(n){for(let i=0;i<n;i++)foods.push(makeFood());}
spawnFood(FOOD_COUNT);

// ---------- Audio ----------
const bgSound=document.getElementById('bgSound'), dotSound=document.getElementById('dotSound'), powerSound=document.getElementById('powerSound');
let audioUnlocked=false;
function unlockAudio(){if(audioUnlocked)return;audioUnlocked=true;bgSound.volume=0.5;bgSound.play().catch(()=>{});}
['pointerdown','touchstart','mousedown','keydown'].forEach(ev=>window.addEventListener(ev,unlockAudio,{once:true,passive:true}));

// ---------- Joystick ----------
const joyWrap=document.getElementById('joyWrap'), joyKnob=document.getElementById('joyKnob');
let joy={active:false,id:null,ox:0,oy:0,dx:0,dy:0};
function setKnob(dx,dy){const max=40,d=Math.hypot(dx,dy)||1;const nx=(d>max?dx*(max/d):dx),ny=(d>max?dy*(max/d):dy);joyKnob.style.transform=`translate(${nx}px,${ny}px)`;joy.dx=nx/max;joy.dy=ny/max;}
joyWrap.addEventListener('pointerdown',e=>{e.preventDefault();joy.active=true;joy.id=e.pointerId;const rect=joyWrap.getBoundingClientRect();joy.ox=rect.left+rect.width/2;joy.oy=rect.top+rect.height/2;setKnob(e.clientX-joy.ox,e.clientY-joy.oy);joyWrap.setPointerCapture(e.pointerId);});
joyWrap.addEventListener('pointermove',e=>{if(!joy.active||e.pointerId!==joy.id)return;e.preventDefault();setKnob(e.clientX-joy.ox,e.clientY-joy.oy);});
function endJoy(e){if(!joy.active||e.pointerId!==joy.id)return;joy.active=false;joy.id=null;joy.dx=0;joy.dy=0;joyKnob.style.transform='translate(0,0)';}
joyWrap.addEventListener('pointerup',endJoy);joyWrap.addEventListener('pointercancel',endJoy);

// ---------- Movement & Game ----------
function playerSpeed(p){
  const effMass = p.shrinkActive ? Math.max(6, p.mass * 0.5) : p.mass;
  return 5.2/Math.pow(effMass,0.18);
}
function enforceWalls(p){if(p.x<0||p.y<0||p.x>WORLD.w||p.y>WORLD.h){killPlayer(p);}}
function getRadius(p){ return p.radius() * (p.shrinkActive ? 0.6 : 1); } 
function eatFood(p){
  for(let i=foods.length-1;i>=0;i--){
    let f=foods[i];
    if(dist(p.x,p.y,f.x,f.y)<getRadius(p)+f.r){
      p.mass+=0.6;p.score++;if(p===player){score++;updateUI();}
      foods.splice(i,1);foods.push(makeFood());
      try{dotSound.currentTime=0;dotSound.play();}catch(e){}
    }
  }
}
function eatPlayers(){
  for(let p of players){
    if(p.dead||p===player)continue;
    const d=dist(player.x,player.y,p.x,p.y);
    if(getRadius(player)>getRadius(p)+5&&d<getRadius(player)){
      player.mass+=p.mass*0.2;player.score+=p.score;score=player.score;killPlayer(p);updateUI();
    } else if(getRadius(p)>getRadius(player)+5&&d<getRadius(p)){
      p.mass+=player.mass*0.2;p.score+=player.score;killPlayer(player);
    }
  }
}

// ---------- Draw ----------
function drawGrid(){const g=GRID_SIZE;let startX=camera.x-window.innerWidth/2;let startY=camera.y-window.innerHeight/2;let x0=Math.floor(startX/g)*g;let y0=Math.floor(startY/g)*g;ctx.save();ctx.lineWidth=1;ctx.strokeStyle='rgba(0,0,0,0.04)';for(let x=x0;x<startX+window.innerWidth;x+=g){ctx.beginPath();let sx=x-startX;ctx.moveTo(sx,0);ctx.lineTo(sx,window.innerHeight);ctx.stroke();}for(let y=y0;y<startY+window.innerHeight;y+=g){ctx.beginPath();let sy=y-startY;ctx.moveTo(0,sy);ctx.lineTo(window.innerWidth,sy);ctx.stroke();}ctx.restore();}
function drawPlayer(p){
  const ps=worldToScreen(p.x,p.y);
  const r = getRadius(p);
  ctx.beginPath();
  ctx.fillStyle=p.color;
  ctx.arc(ps.x,ps.y,r,0,Math.PI*2);
  ctx.fill();
  ctx.font='12px system-ui';ctx.fillStyle='#0f172a';ctx.textAlign='center';
  ctx.fillText(p.name,ps.x,ps.y-r-6);
}
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#fff';ctx.fillRect(0,0,window.innerWidth,window.innerHeight);
  drawGrid();
  const topLeft=worldToScreen(0,0),bottomRight=worldToScreen(WORLD.w,WORLD.h);
  ctx.save();ctx.strokeStyle='#000';ctx.lineWidth=12;ctx.strokeRect(topLeft.x,topLeft.y,bottomRight.x-topLeft.x,bottomRight.y-topLeft.y);ctx.restore();
  for(const f of foods){
    const s=worldToScreen(f.x,f.y);
    if(s.x<-50||s.x>window.innerWidth+50||s.y<-50||s.y>window.innerHeight+50)continue;
    ctx.beginPath();ctx.fillStyle=f.color;ctx.arc(s.x,s.y,f.r,0,Math.PI*2);ctx.fill();
  }
  for(let p of players)drawPlayer(p);
}

// ---------- MiniMap ----------
const miniHolder=document.getElementById('miniCanvasHolder');const miniW=120,miniH=80;const miniCanvas=document.createElement('canvas');miniCanvas.width=miniW;miniCanvas.height=miniH;miniCanvas.style.width=miniW+'px';miniCanvas.style.height=miniH+'px';miniHolder.appendChild(miniCanvas);const mctx=miniCanvas.getContext('2d');
function renderMiniMap(){
  mctx.clearRect(0,0,miniW,miniH);mctx.fillStyle='#0b0b0b';mctx.fillRect(0,0,miniW,miniH);
  for(const f of foods){const mx=(f.x/WORLD.w)*miniW,my=(f.y/WORLD.h)*miniH;mctx.fillStyle=f.color;mctx.fillRect(mx-1,my-1,2,2);}
  for(const p of players){const px=(p.x/WORLD.w)*miniW,py=(p.y/WORLD.h)*miniH;mctx.fillStyle=p===player?'#06b6d4':'#ef4444';mctx.beginPath();mctx.arc(px,py,3,0,Math.PI*2);mctx.fill();}
  mctx.strokeStyle='#000';mctx.lineWidth=2;mctx.strokeRect(0,0,miniW,miniH);
}
function updateUI(){document.getElementById('playerScore').innerText=score;document.getElementById('scoreNum').innerText=score;}

// ---------- Init ----------
function init(){
  player=new Player('me',nameEl.innerText,WORLD.w/2,WORLD.h/2,'#06b6d4');
  players.push(player);
}
init();
updateUI();

// ---------- Power ----------
const shrinkBtn = document.getElementById('shrinkBtn');
function startShrink(){if(!player||player.shrinkActive)return;player.shrinkActive=true;shrinkBtn.classList.add('active');try{powerSound.currentTime=0;powerSound.play().catch(()=>{});}catch(e){}}
function stopShrink(){if(!player||!player.shrinkActive)return;player.shrinkActive=false;shrinkBtn.classList.remove('active');try{powerSound.pause();powerSound.currentTime=0}catch(e){}}
shrinkBtn.addEventListener('pointerdown',e=>{e.preventDefault();startShrink();shrinkBtn.setPointerCapture&&shrinkBtn.setPointerCapture(e.pointerId);});
shrinkBtn.addEventListener('pointerup',e=>{e.preventDefault();stopShrink();});
shrinkBtn.addEventListener('pointercancel',e=>{stopShrink();});

// ---------- Loop ----------
let prev=performance.now();
function loop(now){
  const dt=Math.min((now-prev)/16.6667,4);prev=now;
  const sp=playerSpeed(player)*dt;
  if(joy.active){const mag=Math.hypot(joy.dx,joy.dy);if(mag>0.05){player.vx=(joy.dx/mag)*sp;player.vy=(joy.dy/mag)*sp;}else{player.vx*=0.86;player.vy*=0.86;}}else{player.vx*=0.86;player.vy*=0.86;}
  player.x+=player.vx;player.y+=player.vy;
  enforceWalls(player);eatFood(player);eatPlayers();
  camera.x+=(player.x-camera.x)*0.14;camera.y+=(player.y-camera.y)*0.14;
  draw();renderMiniMap();
  // multiplayer position send
  if(socket.readyState===1){
    socket.send(JSON.stringify({type:'move',id:player.id,x:player.x,y:player.y,mass:player.mass,score:player.score}));
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
setInterval(()=>{if(foods.length<FOOD_COUNT)spawnFood(FOOD_COUNT-foods.length);},1500);
</script>
</body>
</html>
