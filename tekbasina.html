<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Mini Brawl Solo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body {
  margin:0; padding:0; height:100%;
  overflow:hidden;
  background:#c79a66; /* Brawl Stars tarzı kahverengi */
  font-family:'Lilita One', cursive;
}
#canvas {
  display:block;
  background:#d4b07b; /* Harita rengi kahverengi ton */
  border:3px solid #aaa;
  border-radius:12px;
  margin:0 auto;
  touch-action:none;
}
#joystick {
  position:fixed; left:20px; bottom:20px;
  width:100px; height:100px;
  background:rgba(200,200,200,0.25);
  border-radius:50%;
  touch-action:none; z-index:10;
}
#stick {
  position:absolute; width:40px; height:40px;
  left:30px; top:30px;
  background:rgba(100,100,100,0.7);
  border-radius:50%;
}
#fireButton {
  position:fixed; right:20px; bottom:20px;
  width:120px; height:120px;
  border-radius:50%;
  background:red; color:white;
  font-size:18px; text-align:center;
  line-height:120px; user-select:none; z-index:10;
}
#fireStick {
  position:absolute; width:60px; height:60px;
  left:30px; top:30px;
  background:rgba(255,255,255,0.5);
  border-radius:50%; pointer-events:none;
}
#emojiButton {
  position:fixed; right:30px; bottom:150px;
  width:60px; height:60px;
  border-radius:50%;
  background:url('emoji.png') no-repeat center/contain;
  z-index:10;
}
#respawnText {
  position:fixed; top:50%; left:50%;
  transform:translate(-50%,-50%);
  font-size:36px; font-weight:bold;
  color:#b22222; text-shadow:2px 2px 4px #000;
  pointer-events:none; display:none;
}
</style>
</head>
<body>

<canvas id="canvas"></canvas>
<div id="joystick"><div id="stick"></div></div>
<div id="fireButton"><div id="fireStick"></div></div>
<div id="emojiButton"></div>
<div id="respawnText"></div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const socket = new WebSocket('ws://localhost:8080');

const gameWidth = 1600, gameHeight = 1000, playerSize = 48;
let x = Math.random() * (gameWidth - playerSize), y = Math.random() * (gameHeight - playerSize);
let speed = 0.8, health = 6500, maxHealth = 6500, isAlive = true;
let bullets = [], maxAmmo = 3, currentAmmo = 3, bulletSpeed = 7;
let muzzleFlashes = [], explosions = [];
let players = {};
let playerId;

// Oyuncu adı
let oyuncuAdi = localStorage.getItem("oyuncuAdi") || "Oyuncu";

const blocks = [
  { x: 400, y: 150, w: 150, h: 150 },
  { x: 1100, y: 150, w: 150, h: 150 },
  { x: 700, y: 500, w: 200, h: 200 },
  { x: 300, y: 800, w: 170, h: 170 },
  { x: 1150, y: 750, w: 180, h: 180 },
];

// WebSocket bağlantısı açıldığında
socket.onopen = () => {
  console.log('Connected to server');
};

// Sunucudan mesaj alındığında
socket.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if (data.type === 'init') {
    players = data.players;
    playerId = data.playerId; // Oyuncu ID'sini al
  } else if (data.type === 'update') {
    players[data.playerId] = data.player; // Diğer oyuncuların durumunu güncelle
  } else if (data.type === 'bullet') {
    drawBullet(data.bullet); // Mermiyi çiz
  } else if (data.type === 'emoji') {
    showEmoji(data.playerId); // Emoji göster
  } else if (data.type === 'disconnect') {
    delete players[data.playerId]; // Oyuncu bağlantısı kesildiğinde sil
  }
};

// --- Hareket joystick ---
const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");
let joyX = 0, joyY = 0;
let moveTouchId = null;

joystick.addEventListener("touchstart", e => {
  if (moveTouchId === null) {
    moveTouchId = e.changedTouches[0].identifier;
  }
}, { passive: false });

joystick.addEventListener("touchmove", e => {
  for (let t of e.changedTouches) {
    if (t.identifier === moveTouchId) {
      e.preventDefault();
      const rect = joystick.getBoundingClientRect();
      const dx = t.clientX - (rect.left + 50);
      const dy = t.clientY - (rect.top + 50);
      const dist = Math.min(Math.sqrt(dx * dx + dy * dy), 40);
      const angle = Math.atan2(dy, dx);
      joyX = Math.cos(angle) * dist / 40;
      joyY = Math.sin(angle) * dist / 40;
      stick.style.left = `${30 + joyX * 20}px`;
      stick.style.top = `${30 + joyY * 20}px`;
    }
  }
}, { passive: false });

joystick.addEventListener("touchend", e => {
  for (let t of e.changedTouches) {
    if (t.identifier === moveTouchId) {
      joyX = 0; joyY = 0;
      stick.style.left = "30px"; stick.style.top = "30px";
      moveTouchId = null;
    }
  }
});

// --- Ateş joystick ---
const fireButton = document.getElementById("fireButton");
const fireStick = document.getElementById("fireStick");
let aiming = false, aimX = 0, aimY = 0;
let fireTouchId = null;

fireButton.addEventListener("touchstart", e => {
  if (fireTouchId === null) {
    fireTouchId = e.changedTouches[0].identifier;
    aiming = true;
  }
}, { passive: false });

fireButton.addEventListener("touchmove", e => {
  for (let t of e.changedTouches) {
    if (t.identifier === fireTouchId) {
      e.preventDefault();
      const rect = fireButton.getBoundingClientRect();
      const dx = t.clientX - (rect.left + fireButton.offsetWidth / 2);
      const dy = t.clientY - (rect.top + fireButton.offsetHeight / 2);
      const dist = Math.min(Math.sqrt(dx * dx + dy * dy), 50);
      const angle = Math.atan2(dy, dx);
      aimX = Math.cos(angle) * dist / 50;
      aimY = Math.sin(angle) * dist / 50;
      fireStick.style.left = `${30 + aimX * 25}px`;
      fireStick.style.top = `${30 + aimY * 25}px`;
    }
  }
}, { passive: false });

fireButton.addEventListener("touchend", e => {
  for (let t of e.changedTouches) {
    if (t.identifier === fireTouchId) {
      if (aiming && currentAmmo > 0) {
        let dx = aimX, dy = aimY;
        if (dx === 0 && dy === 0) dy = -1;
        const angle = Math.atan2(dy, dx);
        const bullet = {
          x: x + playerSize / 2, y: y + playerSize / 2,
          dx: Math.cos(angle) * bulletSpeed,
          dy: Math.sin(angle) * bulletSpeed
        };
        bullets.push(bullet);
        muzzleFlashes.push({ x: x + playerSize / 2, y: y + playerSize / 2, life: 10 });
        currentAmmo--;

        // Mermiyi sunucuya gönder
        socket.send(JSON.stringify({ type: 'bullet', bullet: bullet }));
      }
      aiming = false; aimX = 0; aimY = 0;
      fireStick.style.left = "30px"; fireStick.style.top = "30px";
      fireTouchId = null;
    }
  }
});

// Emoji
const emojiButton = document.getElementById("emojiButton");
let emojiActive = false, emojiCountdown = 0, emojiOpacity = 1;
emojiButton.addEventListener("touchstart", () => {
  emojiActive = true;
  emojiCountdown = 5; emojiOpacity = 1;
  const interval = setInterval(() => {
    emojiCountdown -= 0.1;
    emojiOpacity = emojiCountdown / 5;
    if (emojiCountdown <= 0) { emojiActive = false; clearInterval(interval); }
  }, 100);

  // Emoji etkinliğini sunucuya gönder
  socket.send(JSON.stringify({ type: 'emoji', playerId: playerId }));
});

// Mermi dolumu
setInterval(() => { if (currentAmmo < maxAmmo) currentAmmo++; }, 800);

function rectsCollide(ax, ay, aw, ah, bx, by, bw, bh) {
  return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
}
function checkPlayerCollision(nx, ny) {
  if (nx < 0 || ny < 0 || nx > gameWidth - playerSize || ny > gameHeight - playerSize) return true;
  for (let block of blocks) if (rectsCollide(nx, ny, playerSize, playerSize, block.x, block.y, block.w, block.h)) return true;
  return false;
}
function checkBulletCollision(b) {
  if (b.x < 0 || b.y < 0 || b.x > gameWidth || b.y > gameHeight) return true;
  for (let block of blocks) if (rectsCollide(b.x - 2, b.y - 2, 4, 4, block.x, block.y, block.w, block.h)) return true;
  return false;
}

const karakter = new Image();
karakter.src = "karakter.png";

function resizeCanvas() {
  const dpr = window.devicePixelRatio || 1;
  canvas.style.width = window.innerWidth + "px";
  canvas.style.height = window.innerHeight + "px";
  canvas.width = window.innerWidth * dpr;
  canvas.height = window.innerHeight * dpr;
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.scale(dpr, dpr);
}
resizeCanvas(); window.addEventListener("resize", resizeCanvas);

function gameLoop() {
  requestAnimationFrame(gameLoop);
  if (isAlive) {
    let nx = x + joyX * speed, ny = y + joyY * speed;
    if (!checkPlayerCollision(nx, y)) x = nx;
    if (!checkPlayerCollision(x, ny)) y = ny;

    // Oyuncu durumunu sunucuya gönder
    socket.send(JSON.stringify({ type: 'update', playerId: playerId, player: { x: x, y: y, health: health, ammo: currentAmmo } }));
  }
  bullets = bullets.filter(b => {
    b.x += b.dx; b.y += b.dy;
    if (checkBulletCollision(b)) {
      explosions.push({ x: b.x, y: b.y, life: 15 });
      return false;
    }
    return true;
  });
  muzzleFlashes.forEach(f => f.life--);
  muzzleFlashes = muzzleFlashes.filter(f => f.life > 0);
  explosions.forEach(ex => ex.life--);
  explosions = explosions.filter(ex => ex.life > 0);

  if (health <= 0 && isAlive) {
    isAlive = false;
    setTimeout(() => {
      health = maxHealth; isAlive = true;
      x = Math.random() * (gameWidth - playerSize);
      y = Math.random() * (gameHeight - playerSize);
    }, 5000);
  }

  const screenWidth = canvas.width / (window.devicePixelRatio || 1);
  const screenHeight = canvas.height / (window.devicePixelRatio || 1);
  let camX = x + playerSize / 2 - screenWidth / 2;
  let camY = y + playerSize / 2 - screenHeight / 2;
  camX = Math.max(0, Math.min(camX, gameWidth - screenWidth));
  camY = Math.max(0, Math.min(camY, gameHeight - screenHeight));
  ctx.clearRect(0, 0, screenWidth, screenHeight);
  ctx.save(); ctx.translate(-camX, -camY);

  // Duvarlar
  blocks.forEach(b => {
    const gradient = ctx.createLinearGradient(b.x, b.y, b.x + b.w, b.y + b.h);
    gradient.addColorStop(0, "#ffd27f"); gradient.addColorStop(1, "#b36b00");
    ctx.fillStyle = gradient;
    ctx.fillRect(b.x, b.y, b.w, b.h);
  });

  // Karakter
  if (isAlive) {
    ctx.drawImage(karakter, x, y, playerSize, playerSize);
    ctx.fillStyle = "#000"; ctx.font = "bold 16px Lilita One";
    ctx.textAlign = "center"; ctx.fillText(oyuncuAdi, x + playerSize / 2, y - 12);
    ctx.fillStyle = "red"; ctx.fillRect(x, y - 20, playerSize, 5);
    ctx.fillStyle = "limegreen"; ctx.fillRect(x, y - 20, playerSize * (health / maxHealth), 5);
    for (let i = 0; i < maxAmmo; i++) {
      ctx.fillStyle = i < currentAmmo ? "#FFD700" : "#999";
      ctx.fillRect(x + i * 14, y - 28, 12, 5);
    }
    if (emojiActive) {
      ctx.save(); ctx.globalAlpha = emojiOpacity;
      const img = new Image(); img.src = "emoji.png";
      ctx.drawImage(img, x + playerSize + 5, y + 5, 32, 32);
      ctx.restore();
    }
  }

  // Diğer oyuncuları çiz
  for (let id in players) {
    if (id !== playerId) {
      const player = players[id];
      ctx.drawImage(karakter, player.x, player.y, playerSize, playerSize);
      ctx.fillStyle = "red"; ctx.fillRect(player.x, player.y - 20, playerSize, 5);
      ctx.fillStyle = "limegreen"; ctx.fillRect(player.x, player.y - 20, playerSize * (player.health / maxHealth), 5);
    }
  }

  // Mermiler
  bullets.forEach(b => {
    ctx.lineWidth = 4; ctx.strokeStyle = "black";
    ctx.beginPath(); ctx.moveTo(b.x - 5, b.y); ctx.lineTo(b.x + 5, b.y); ctx.stroke();
    ctx.strokeStyle = "yellow"; ctx.beginPath(); ctx.moveTo(b.x - 5, b.y); ctx.lineTo(b.x + 5, b.y); ctx.stroke();
  });

  // Muzzle flash
  muzzleFlashes.forEach(f => {
    ctx.save(); ctx.globalAlpha = f.life / 10;
    ctx.fillStyle = "orange"; ctx.beginPath(); ctx.arc(f.x, f.y, 12 - f.life, 0, Math.PI * 2); ctx.fill();
    ctx.restore();
  });

  // Patlamalar
  explosions.forEach(ex => {
    ctx.save();
    ctx.globalAlpha = ex.life / 15;
    const radius = 20 - ex.life;
    const grad = ctx.createRadialGradient(ex.x, ex.y, 0, ex.x, ex.y, radius);
    grad.addColorStop(0, "yellow");
    grad.addColorStop(1, "red");
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.arc(ex.x, ex.y, radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  });

  // Nişan çizgisi
  if (aiming) {
    const startX = x + playerSize / 2, startY = y + playerSize / 2;
    const len = 200;
    ctx.strokeStyle = "rgba(255,255,255,0.6)";
    ctx.lineWidth = 10;
    ctx.beginPath();
    ctx.moveTo(startX + aimX * playerSize / 2, startY + aimY * playerSize / 2);
    ctx.lineTo(startX + aimX * len, startY + aimY * len);
    ctx.stroke();
  }

  ctx.restore();
}

function drawBullet(bullet) {
  ctx.lineWidth = 4; ctx.strokeStyle = "black";
  ctx.beginPath(); ctx.moveTo(bullet.x - 5, bullet.y); ctx.lineTo(bullet.x + 5, bullet.y); ctx.stroke();
  ctx.strokeStyle = "yellow"; ctx.beginPath(); ctx.moveTo(bullet.x - 5, bullet.y); ctx.lineTo(bullet.x + 5, bullet.y); ctx.stroke();
}

function showEmoji(playerId) {
  // Emoji gösterme işlemi
}

gameLoop();
</script>
</body>
</html>
